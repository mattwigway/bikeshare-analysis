\documentclass[letterpaper,11pt]{article}
\usepackage[american]{babel}

\usepackage[hidelinks]{hyperref}

% I like international letters
\usepackage[utf8]{inputenc}

\usepackage[authordate,strict,sorting=nyt,babel=other,cmsdate=both]{biblatex-chicago}
\usepackage{mathtools}
\bibliography{UCSB-GEOG172}

\usepackage{fancyhdr}
\pagestyle{fancy}
\lhead{\emph{Matthew Wigginton Conway}}
\chead{\emph{Draft}}
\rhead{\emph{\today}}

\usepackage{graphicx}

\usepackage{geometry}

\usepackage{listings}
\lstset{language=R,breaklines=true}

\title{Analyzing the Effects of Space and Time on Bikeshare Use: A Case Study in Washington, DC}
\author{Matthew Wigginton Conway}
\date{\today}

\begin{document}
\maketitle

Bikesharing is a relatively new form of shared transportation wherein
bikes are deposited at stations throughout a city. Users pay an annual
fee and they can then take bikes from any station and return them to
any station. These systems generate a wealth of data. The stations are
electronic, so each time a trip is taken, a record is stored in a
database with the origin, destination, start and end times of that
trip. For some systems, this data is freely available online. This
project aims to use data on the approximately 4.5 million trips taken
on Washington, DC's Capital Bikeshare system from 2010 through the
present to examine how time of day and station location affect the
usage of the bikeshare system.

The data are avai

\section{Time of Day Effects}

One of the chief difficulties of any bikeshare system is keeping
bicycles balanced across the system. The problem is doubly
constrained, because the system operator not only needs to keep enough
bikes available at all stations, but also needs to prevent stations
from becoming completely full and thus preventing people from parking
their bikes. This is usually accomplished via a fleet of trucks which
pick up bikes from overfull stations and rebalance them to empty or
nearly empty stations.

For the time of day portion of this project, the data on bike share
trips was used to determine whether the distribution of start and end
stations differs significantly between time periods. Eight time
periods were defined: morning (6a--9a), midday (9a--3p), afternoon
(3p--7p) and overnight (7p--9p) for both weekdays and weekends. The
boundaries of the time periods are the same as those used in the
Metropolitan Washington Council of Governments travel model, although
MWCOG does not further divide the time periods into weekday and
weekend patterns \autocite[14]{MWCOG2013}.

\subsection{Methodology}

Each trip in the data was first assigned a time period based on its
start time.\footnote{See labeling.R.}\marginpar{explain where the
  scripts are} For each time period, an origin-destination matrix was
created, showing the number of trips between each station pair. The
matrices were then compared pairwise, comparing each time period to
every other time period. The following test statistic was computed for
each pairwise comparison.

\begin{equation}\label{eq:timets}
 \displaystyle\sum_i \sum_j (t_{ij,1} - t_{ij,2})^2 \over
 (\displaystyle \sum_i \sum_j t_{ij,2})^2
\end{equation}

Where $i$ and $j$ represent origin and destination stations,
respectively, $t_{ij,1}$ is trips from origin $i$ to destination $j$
in time period 1, and $t_{ij,2}$ is trips from origin $i$ to
destination $j$ in time period 2. The denominator of the equation is
to scale the test statistic based on the total number of trips taken
in the time period, so that the magnitude of the test statistic is not
affected by the absolute number of trips taken in the time
period. Additionally, matrix 2 is scaled before calculation such
that the total number of trips in each matrix are the same. That is,

\begin{equation}\label{eq:timeconstraint}
  \displaystyle \sum_i \sum_j t_{ij,1} = \sum_i \sum_j t_{ij,2}
\end{equation}

Once test statistics were computed for each pair of time periods, a
Monte Carlo simulation was undertaken to determine whether the time
periods differ significantly. The trips were originally used to
generate the origin-destination randomly reassigned to different time
periods. The number of trips in each time period was held
constant. Since this worked by relabeling the existing trips, the
distribution of trips to origins and destinations was constant over
all time periods though it varied within time
periods. Origin-destination matrices were then calculated using the
relabeled trips, and the same pairwise comparison was done and test
statistics computed. This process was repeated 999 times.

\subsection{Results}

It was found that there is an effect of time of day on the
origin-destination matrices. For every pair, there was no test
statistic from the Monte Carlo simulation higher than the test statistic
from the observed pair. The p-values between time periods are show below.

\noindent \input{pval_table}

The p-value represents the probability that the observed differences
between two time periods could have occurred by chance. As we can see,
there is a statistically significant difference between every time
period and every other time period ($p < 0.05$).

\subsection{Discussion}

Such a result should not be surprising. To take a trivial example,
commuters may ride from a residential area to a Metro stop each
morning, and the reverse each evening. Weekend trips may represent
people using the system for pleasure or entertainment rather than
commuting. The data confirm that usage patterns (measured by station
origin-destination matrices) differ for each time period.

This intensifies the need for rebalancing. Bikeshare demand is often not
in equilibrium, so bikes must be moved from station to station by the system 
operator in order to ensure that there are available bikes and available docks
at all stations \autocite[108]{IDAE2007}. That is, if most people ride bikes from
residential areas to commercial areas in the morning, there will not be enough bikes
available in residential areas, and there will not be enough docks available in
commercial areas. The problem is doubly-constrained, because there need to both be
bikes available at each station in order for users to take a bike, and empty docks
in order to return bikes. An interesting project would be to determine to what extent
demand is cyclical. If the demand is cyclical, with people biking to 
commercial areas in the morning and back to residential areas in the afternoon,
providing a sufficient number of bikes would ameliorate the need for rebalancing.
There may, however, be a general trend as well. For instance, people may prefer to
bikeshare to work if they are in a hurry\footnote{People often take bikeshare when it is faster than transit 
\autocite{Wong2012}}, and take transit home if they are tired. In this case, there could be a general trend
of bikes moving towards commercial areas. This could be tested using the trip
history data, but is beyond the scope of this project.

\section{Effects of Space on Bikeshare Use}

\begin{figure}[t]
  \label{boxcox}
  \includegraphics[width=\textwidth]{boxcox.pdf}
  \caption{Station popularity, before and after Box-Cox transformation.}
\end{figure}

\clearpage\newpage
\printbibliography

\newpage
\newgeometry{hmargin=0.5in,vmargin=1in}
\fancyhfoffset[E,O]{0pt}
\appendix
\section{Source Code Listings}

This appendix contains source code listings for the code used in this
project. Data management and retrieval code is primarily Python,
whereas analysis code is written in R.

\subsection{Data Management}

Scripts in this section are used to retrieve data from Capital
Bikeshare and process it into a format suitable for analysis.

\subsubsection{fetchData.sh}

This shell script simply calls the other scripts to retrieve and
process the data.

\lstinputlisting[language=sh]{../datamgmt/fetchData.sh}

\subsubsection{csvMerge.py}

This script merges all of the quarterly CSV files into one large CSV
file, merging columns that are the same but have different names in
data files from different time periods.

\lstinputlisting[language=Python]{../datamgmt/csvMerge.py}

\subsubsection{expandFileWithXY.py}

Station locations are not included in the trip history feed, only
their names and numbers. This script takes a trip history file and
adds spatial coordinates of the stations, based on the locations of
stations in the CaBi XML API. It also projects the location to UTM so that
Euclidean geometry can be used in calculations.

\lstinputlisting[language=Python]{../datamgmt/expandFileWithXY.py}

\subsection{Effects of Time on Bikeshare Use}

This section contains scripts used to evaluate the effects of time on
bikeshare use.

\subsubsection{periods.R}

This code simply defines how the time periods are coded. They are
stored as single numbers in the file to reduce the file size.

\lstinputlisting{../analysis/periods.R}

\subsubsection{load\_data.R}

This code loads and filter the trip data from CaBi, dropping trips
over 20 km or 24 hours.

\lstinputlisting{../analysis/load_data.R}

\subsubsection{labeling.R}

This code takes the Capital Bikeshare trip data, cleaned by the above
scripts, and labels it based on trip start time period.

\lstinputlisting{../analysis/labeling.R}

\subsubsection{relabel.R}

This script calculates test statistics for the observed distribution
of trips then randomizes the distribution of trips to time periods,
conducting a Monte Carlo simulation to determine the p-value of the
observed trip distribution.

\lstinputlisting{../analysis/relabel.R}

\subsection{Effects of Space}
\subsubsection{morans\_i.R}

This script was used to calculate Moran's $I$ to calculate how
spatially autocorrelated the popularity of bikeshare stations is.

\lstinputlisting{../analysis/morans_i.R}

\emph{Copyright Â© 2013 Matthew Wigginton Conway. All rights reserved}

\end{document}
